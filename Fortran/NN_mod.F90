module NN
    implicit none

    contains

    subroutine l_relu(arr, N)
        implicit none

        integer, intent(in) :: N
        real(kind = 8), intent(INOUT), dimension(N, 1) :: arr
        integer :: i

        do i = 1, N
            if (arr(i, 1) < 0.0) then
                arr(i, 1) = 0.01 * arr(i, 1) 
            end if
        end do
        
    end subroutine l_relu

    subroutine read_w(file_name, w_name, mat, N1, N2)
        real(kind = 8), intent(out), dimension(:,:) :: mat
        character(len=*) :: file_name, w_name
        integer, intent(in) :: N1, N2

        open (unit = 10, file=file_name, status = "old") 
        
        close(10)

    end subroutine read_w

    subroutine classify(input, classification)
        real(kind = 8), intent(inout), dimension(8,1) :: input
        integer, intent(out) :: classification

        real(kind = 8), dimension(16, 8) :: fc1_w
        real(kind = 8), dimension(16, 1) :: fc1_b

        real(kind = 8), dimension(2, 16) :: fc2_w
        real(kind = 8), dimension(2, 1) :: fc2_b

        real (kind = 8), dimension(16, 1) :: temp1
        real (kind = 8), dimension(2, 1) :: temp2

        real (kind = 8) :: min_val, max_val

        min_val = minval(input(:,1))
        max_val = maxval(input(:,1))

        input(1:7,1) = -1 + ( input(1:7,1) -  min_val) * 2.0 / (max_val - min_val)

        fc1_w = reshape([-0.3494586, 1.4086386, -1.5963485, 1.1167134, -0.38775367, -0.85556597, 1.1059996, -0.671563, 0.050759546, -0.650722, 0.7240435, -1.2372845, -0.79383796, 0.5529582, 1.4097283, -1.1833408, 0.3239814, -0.31454444, 1.0651594, -0.25041237, -0.22440208, 0.9360802, -0.74616575, -0.19450942, 0.043857932, 0.8511929, 0.2386647, 1.1455798, 0.9548695, -0.20641705, -0.06948202, 0.101596326, 0.6951378, 0.42475352, 1.6859119, -0.9241148, -1.0657426, 0.19718482, 0.4095433, -1.416926, -0.012679624, 0.104560524, 0.62450576, 1.6349591, 0.9851863, -0.23168916, -0.9781, 0.8554866, -0.436441, 2.289598, 0.25891197, -0.82032084, -1.1888598, 0.049802013, 2.175047, -1.4883752, 0.32282016, -0.43852875, 0.39626214, -0.34334773, -0.23446772, -0.5600062, -0.19601557, -0.3891512, -1.2483301, 1.2013749, -1.2634141, -0.43017882, 0.30892628, 0.4304394, 1.0846772, 0.32481617, 0.96098846, 0.8961746, -0.67440623, -1.7339851, -0.38037562, -0.6060334, -0.06284777, -1.512661, -0.944193, 0.546659, 0.4180359, -0.2695023, 1.1251086, 0.50272495, 0.5559879, 0.2925843, 0.5549273, 0.6471844, -0.8365946, -0.33894426, -0.0052949768, -0.43233672, 0.22085479, -0.8741017, -0.32224286, 0.65086174, 0.53571606, 0.059319247, -1.4321054, -0.96640384, 0.072983414, -1.5505593, -1.3618819, -1.028095, -0.6055051, 0.8877591, -0.19339003, 0.2216086, 0.3123703, 0.9704603, -0.8479542, 0.35984316, -0.0042555607, 0.77339685, -0.5319276, 0.4746232, 0.47084263, -0.33044294, 0.09058956, 0.101701386, -0.56095105, -0.86824423, 0.62526786, 0.63251626, 0.38875052, -0.23737863], shape = [16,8])
        fc1_b = reshape([-0.7604262, 0.0775104, 0.0019669298, 0.49476877, -0.0036458296, 0.16498171, 0.06969554, -0.0032051955, 0.074481755, -0.034850843, -0.4158969, -0.0030337803, 0.8863704, 0.42020145, -0.00075900427, 0.0069708955], shape = [16,1])
        fc2_w = reshape([-1.506082, 0.7809944, -1.6572075, 2.418742, 2.765811, -3.2188206, 0.7735173, -0.860119, -3.6428058, 3.7602408, 1.0466253, -1.7745771, -1.7067121, 1.7219046, -1.8028169, 2.671077, 0.4019523, -1.4301188, 2.0440135, -1.9701802, -0.18116815, 1.0901679, -10.831869, 10.983477, 1.8880159, -1.4827002, 0.74745643, -0.5514677, 1.7075659, -1.9002144, 3.574966, -3.6044095], shape =[2, 16])
        fc2_b = reshape([0.61176103, -0.61175907], shape =[2, 1])


        temp1 = fc1_b + matmul(fc1_w, input)
        call l_relu(temp1, 16)
        temp2 = fc2_b + matmul(fc2_w, temp1)

        if (temp2(1,1) >= temp2(2,1)) then
            classification = 0
        else
            classification = 1
        end if

        !F.softmax(fc2_b.unsqueeze(-1) + (fc2_w @ F.leaky_relu(fc1_b.unsqueeze(-1) + fc1_w @ test.unsqueeze(-1))),dim=0)


    end subroutine classify


    
end module NN