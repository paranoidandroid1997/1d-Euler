module NN
    implicit none

    contains

    subroutine l_relu(arr, N)
        implicit none

        integer, intent(in) :: N
        real(kind = 8), intent(INOUT), dimension(N, 1) :: arr
        integer :: i

        do i = 1, N
            if (arr(i, 1) < 0.0) then
                arr(i, 1) = 0.01 * arr(i, 1) 
            end if
        end do
        
    end subroutine l_relu

    subroutine read_w(file_name, w_name, mat, N1, N2)
        real(kind = 8), intent(out), dimension(:,:) :: mat
        character(len=*) :: file_name, w_name
        integer, intent(in) :: N1, N2

        open (unit = 10, file=file_name, status = "old") 
        
        close(10)

    end subroutine read_w

    subroutine classify(input, classification)
        real(kind = 8), intent(inout), dimension(20,1) :: input
        integer, intent(out) :: classification

        real(kind = 8), dimension(8, 20) :: fc1_w
        real(kind = 8), dimension(8, 1) :: fc1_b

        real(kind = 8), dimension(2, 8) :: fc2_w
        real(kind = 8), dimension(2, 1) :: fc2_b

        real (kind = 8), dimension(8, 1) :: temp1
        real (kind = 8), dimension(2, 1) :: temp2

        real (kind = 8) :: min_val, max_val

        !min_val = minval(input(1:7,1))
        !max_val = maxval(input(1:7,1))

        !input(1:7,1) = -1.0 + ( input(1:7,1) -  min_val) * 2.0 / (max_val - min_val)

        !fc1_w = reshape([-0.3494586, 1.4086386, -1.5963485, 1.1167134, -0.38775367, -0.85556597, 1.1059996, -0.671563, 0.050759546, -0.650722, 0.7240435, -1.2372845, -0.79383796, 0.5529582, 1.4097283, -1.1833408, 0.3239814, -0.31454444, 1.0651594, -0.25041237, -0.22440208, 0.9360802, -0.74616575, -0.19450942, 0.043857932, 0.8511929, 0.2386647, 1.1455798, 0.9548695, -0.20641705, -0.06948202, 0.101596326, 0.6951378, 0.42475352, 1.6859119, -0.9241148, -1.0657426, 0.19718482, 0.4095433, -1.416926, -0.012679624, 0.104560524, 0.62450576, 1.6349591, 0.9851863, -0.23168916, -0.9781, 0.8554866, -0.436441, 2.289598, 0.25891197, -0.82032084, -1.1888598, 0.049802013, 2.175047, -1.4883752, 0.32282016, -0.43852875, 0.39626214, -0.34334773, -0.23446772, -0.5600062, -0.19601557, -0.3891512, -1.2483301, 1.2013749, -1.2634141, -0.43017882, 0.30892628, 0.4304394, 1.0846772, 0.32481617, 0.96098846, 0.8961746, -0.67440623, -1.7339851, -0.38037562, -0.6060334, -0.06284777, -1.512661, -0.944193, 0.546659, 0.4180359, -0.2695023, 1.1251086, 0.50272495, 0.5559879, 0.2925843, 0.5549273, 0.6471844, -0.8365946, -0.33894426, -0.0052949768, -0.43233672, 0.22085479, -0.8741017, -0.32224286, 0.65086174, 0.53571606, 0.059319247, -1.4321054, -0.96640384, 0.072983414, -1.5505593, -1.3618819, -1.028095, -0.6055051, 0.8877591, -0.19339003, 0.2216086, 0.3123703, 0.9704603, -0.8479542, 0.35984316, -0.0042555607, 0.77339685, -0.5319276, 0.4746232, 0.47084263, -0.33044294, 0.09058956, 0.101701386, -0.56095105, -0.86824423, 0.62526786, 0.63251626, 0.38875052, -0.23737863], shape = [16,8])
        fc1_w = reshape([0.15315841, -0.014933763, 0.5466799, 0.30712974, 0.079124734, 0.01768969, 0.48262015, -0.5455654, -0.03537467, 0.021137675, -0.08930946, 0.030645993, -0.057938945, 0.17285699, 0.18794407, 0.31871638, 0.1805459, 0.030731928, 0.1304589, -0.102338955, 0.2838994, 0.005872286, -0.27373812, 0.457581, 0.26638594, 0.039381042, -0.10346346, -0.2812577, 0.6617254, 0.025669023, -0.123529986, 0.105754845, -0.2677963, 0.06643474, -0.11276002, -0.31121972, 0.5138748, -0.097073756, -0.37831268, 0.6700459, 0.08749295, -0.004922563, -0.028794283, 0.0041264514, 0.009342873, 0.008587426, -0.01033214, -0.019368706, 0.01524805, -0.0008669356, 0.016065639, -0.011264821, 0.024083886, 0.002385944, 0.019453099, 0.04309395, 0.057229687, -0.00070833263, 0.034214944, -0.004554069, -0.0366668, 0.004177667, 0.07384227, -0.027460702, -0.06819368, -0.0002193116, 0.019735273, -0.0058504143, 0.02090096, 0.003040193, 0.018633863, -0.013611194, -0.09106975, 0.007752651, -0.04984533, -0.036869325, 0.04892306, -0.011698153, -0.06974396, 0.062468197, 0.69375753, -0.020651214, 0.026381573, 0.49571782, -0.06808378, 0.11881771, 0.5783948, -0.21940902, 0.058565747, 0.019766303, 0.1958018, 0.30773595, -0.2710032, 0.033348415, 0.25181788, -0.04951181, 0.3069959, 0.030679334, 0.15603541, -0.16934294, -0.2608263, -0.015011005, 0.3972855, 0.31334105, -0.13936076, 0.037606005, 0.39953616, -0.18648668, 0.1308358, -0.030049548, -0.0045473585, 0.24923672, -0.7838308, 0.07862275, -0.7396256, -0.00040189837, 1.1073027, -0.11482733, -0.5733136, 0.5600114, -0.028922258, -0.0012558004, 0.014128473, -0.002701441, -0.04476388, -0.0016786736, -0.0025266458, -0.017240614, -0.5322889, 0.028066084, 0.0538444, -0.11577185, 0.19917452, -0.05529553, -0.23838452, 0.22168891, -0.068390645, 0.008662329, -0.044263136, 0.004177231, 0.017173255, -0.012534817, -0.0107561825, 0.080487356, -0.17005473, 0.02544835, -0.21628495, -0.17802815, 0.21241845, -0.057494394, -0.2856622, 0.2432492, 0.021207176, 0.004030349, -0.011526774, -0.0632183, -0.08501386, -0.013491108, -0.11956473, 0.039534267], shape=[8, 20])
        !fc1_b = reshape([-0.7604262, 0.0775104, 0.0019669298, 0.49476877, -0.0036458296, 0.16498171, 0.06969554, -0.0032051955, 0.074481755, -0.034850843, -0.4158969, -0.0030337803, 0.8863704, 0.42020145, -0.00075900427, 0.0069708955], shape = [16,1])
        fc1_b = reshape([-0.3907799, 0.06023793, -0.36605054, -0.046650548, 0.69907707, -0.073601685, -0.50154054, 0.71009886],shape=[8,1])


        fc2_w = reshape([-1.2119217, 1.1785002, 0.096056506, -0.09621019, -1.0274725, 0.43894228, -0.38164598, 0.78386766, 0.44864503, -1.0187023, -0.1834192, 0.19408536, -0.9547796, 0.9513067, 1.0542917, -0.72312576], shape=[2,8])

        fc2_b = reshape([0.5561742, -0.556224], shape =[2, 1])


        temp1 = fc1_b + matmul(fc1_w, input)
        call l_relu(temp1, 8)
        temp2 = fc2_b + matmul(fc2_w, temp1)

        if (temp2(1,1) >= temp2(2,1)) then
            classification = 0
        else
            classification = 1
        end if

        !F.softmax(fc2_b.unsqueeze(-1) + (fc2_w @ F.leaky_relu(fc1_b.unsqueeze(-1) + fc1_w @ test.unsqueeze(-1))),dim=0)


    end subroutine classify

    subroutine classify_ftorch(input, classification)
        real(kind = 8), intent(inout), dimension(20,1) :: input
        integer, intent(out) :: classification

    end subroutine classify_ftorch


    
end module NN